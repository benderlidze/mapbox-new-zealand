<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Add a new layer to a slot</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css'
        type='text/css' />

    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        .mapboxgl-ctrl-top-center {
            top: 0;
            left: 50%;
            position: absolute;
            pointer-events: none;
            z-index: 2;
        }

        .mapboxgl-ctrl-top-center .mapboxgl-ctrl {
            margin: 10px 0 0 10px;
        }


        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px
        }

        #legend {
            background-color: white;
            border-radius: 10px;
            padding: 10px;
            width: 200px;
        }

        #property {
            background-color: white;
            border-radius: 10px;
            padding: 10px;
        }

        #filters {
            background-color: white;
            position: absolute;
            top: 20px;
            left: 20px;
            border-radius: 20px;
            z-index: 10;
            padding: 10px;
        }

        .switcher-div {
            display: flex;
            align-items: center;
            margin: 5px;
        }

        .switcher-div>div {
            margin-left: 5px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 35px;
            height: 15px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: 0.4s;
            transition: 0.4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 11px;
            width: 11px;
            left: 3px;
            bottom: 2px;
            background-color: white;
            -webkit-transition: 0.4s;
            transition: 0.4s;
        }

        input:checked+.slider {
            background-color: #2196f3;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #2196f3;
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(18px);
            -ms-transform: translateX(18px);
            transform: translateX(18px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        #loading {
            background-color: white;
            position: absolute;
            border-radius: 10px;
            z-index: 10;
            padding: 20px;
            font-size: 20px;

            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #property-controls {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }

        #close-controls {
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            display: none;
        }

        #actions {
            display: flex;
            flex-direction: row;
            background-color: white;
            border-radius: 10px;
            padding: 10px;
            gap: 40px
        }

        #info {
            position: absolute;
            background-color: white;
            border-radius: 10px;
            padding: 10px;
            z-index: 1000;

            /* center screen */
            top: 60px;
            left: 50%;
            transform: translate(-50%, 0);
        }

        #list {
            display: flex;
            gap: 2px;
            flex-direction: column;

            background-color: white;
            padding: 10px;
            border-radius: 10px;
        }

        .main {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .top {
            flex: 1;
            position: relative;
        }

        .bottom {
            height: 50px;
            background-color: white;
            margin: 10px;

            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-content: center;
            align-items: center;

        }

        .action-button {
            border: 1px solid #969696;
            padding: 5px 10px;
            border-radius: 5px;

        }

        .center-bottom {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translate(-50%, 0);
        }

        #geocoder {
            position: absolute;
            top: 20px;
            z-index: 1000;
            left: 50%;
            transform: translate(-50%, 0);
        }

        .flex-nowrap {
            display: flex;
            flex-direction: row;
            gap: 10px;
            flex-wrap: nowrap;
        }

        #farm-features-list {
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 230px;
        }



        #modal-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: fit-content;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .modal-title {
            font-size: 20px;
            margin: 0;
        }

        .modal-content {
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }

        .modal-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            flex: 1;
        }

        .modal-button:hover {
            background: #0056b3;
        }

        .modal-button.cancel {
            background: #6c757d;
        }

        .modal-button.cancel:hover {
            background: #5a6268;
        }
    </style>
</head>

<body>
    <!-- Load the `mapbox-gl-geocoder` plugin. -->
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
        type="text/css">

    <div id="info"></div>
    <div id="panel">
        <div id="legend"></div>
        <div id="list"></div>
        <div id="farm-features-list"></div>
    </div>

    <div class="main">
        <div class="top">
            <div id="geocoder"></div>
            <div id="map"></div>
            <div class="center-bottom">
                <div id="property">
                    <div id="property-controls"></div>
                </div>
                <div id="close-controls"></div>
            </div>
        </div>
        <div class="bottom" id="edit-panel">
            <div class="left">
                <div id="actions"></div>
            </div>
            <div class="right">
                <div id="load-polygons"></div>
            </div>
        </div>
    </div>
    <div id="modal-container"></div>

    <script>

        let lockPropertyFromClick = true //init
        let landUseClickLock = true //init

        let currentMode = "simple_select"
        const infoDiv = document.getElementById("info")
        const actionsListDiv = document.getElementById("actions")
        const loadPolygons = document.getElementById("load-polygons")

        const farmFeaturesListDiv = document.getElementById("farm-features-list")
        farmFeaturesListDiv.style.display = "none"

        const propertyListDiv = document.getElementById("list")
        const propertyControlsDiv = document.getElementById("property-controls")
        const closeControl = document.getElementById("close-controls")
        const saveAndLoadDiv = document.getElementById("property")
        saveAndLoadDiv.style.display = "none"

        const editPanel = document.getElementById("edit-panel")

        const switchersEnableDiv = document.getElementById("legend")
        // const soilClasses = ["RFM", "RFW", "UEP", "GOA", "LOV", "LOT", "ZOH", "ZOT", "BOA", "WT", "BOM", "RTB", "LOA", "LIM", "ROT", "ROW", "BOT", "MOBL", "GOT", "BAP", "WX", "ice", "rive", "BAT", "PXM", "BFT", "town", "PIT", "BLA", "UEM", "UYT", "WF", "MOZ", "ZPT", "WS", "RST", "NXT", "ZXP", "RTT", "LOVA", "BLT", "LGT", "MOT", "PPU", "MOI", "NOA", "BOP", "BXT", "XOT", "BAM", "ZDH", "NOM", "UPS", "estu", "BLAD", "BAO", "BST", "GAP", "GRQ", "PPJX", "OMA", "PID", "NOT", "ZPH", "PJM", "BLX", "lake", "BLD", "GRT", "GSC", "PIM", "GOE", "RFT", "PJT", "PPJ", "ERT", "LPT", "BFL", "BMT", "GUFQ", "UST", "EOJC", "MIW", "RFAW", "BFA", "BMG", "PXJN", "BOC", "WO", "BMM", "BSA", "AFST", "BOH", "SIT", "EMT", "SAT", "UEY", "GAT", "ZPZ", "UPT", "GUF", "EOM", "OHM", "PPX", "PLT", "EOJ", "UYM", "LIT", "OHA", "RTM", "PJA", "PJN", "SAH", "SJT", "PXMC", "GSO", "MOBA", "BSM", "GST", "BFM", "RSM", "ERW", "PXJ", "MOM", "BMA", "PXJM", "SJQ", "RXT", "OMM", "RTBP", "GOO", "EMG", "XPT", "ROA", "ZXF", "EOT", "ZXQ", "EOC", "BFMA", "ZXH", "WGFU", "UDP", "NXM", "XNT", "OFA", "PPT", "ROM", "PLM", "quar", "BFP", "ZPP", "ZGT", "NPT", "MOL", "RFA", "WST", "PXJC", "SAM", "OFS", "BFC", "ZXU", "BLM", "GOC", "ROAW", "ATT", "RFMA", "BFAL", "NPA", "GAO", "UDM", "SAW", "MOBT", "EPT", "GRA", "WH", "BOI", "MIM", "RTBL", "PUM", "EODC", "EVT", "SJM", "BOMA", "MPT", "NXA", "BLAM", "MIT", "RTBA", "WHA", "GRO", "ZPU", "PJC", "EVM", "PXT", "EMM", "ZPOZ", "RFMQ", "PPF", "GOM", "ERO", "GOP", "RF?", "WGF", "BSP", "SJL"]

        const soilClasses = [
            { id: 1, name: "steep country", color: "#FF0000" },
            { id: 2, name: "medium to steep country", color: "#FFA500" },
            { id: 3, name: "cultivable rolling country", color: "#800080" },
            { id: 4, name: "River flats", color: "#0000FF" },
        ]

        const farmFeaturesNames = [
            "Agrichemical Storage",
            "Animal Health Storage",
            "Washdown Area",
            "Fuel Storage",
            "Fertiliser Bin",
            "Effluent Pond",
            "Airstrip",
            "Woolshed",
            "Sheep Yards",
            "Cattle Yards",
            "Water take ",
            "Irrigation",
            "Bridge",
            "Consented Culvert",
            "Feed Pad & Feed Lot",
            "Surface Water Intake",
            "Bore",
            "Farm Dump",
            "Offal Hole",
            "Old Sheep dip",
            "Private Drinking Water Outlet",
        ]

        const selectedBasePolygons = createObservableArray(callback);
        const landUseColors = createObservableArray(() => {
        });

        const drawPontLayers = ["gl-draw-point-point-stroke-inactive.cold", "gl-draw-point-inactive.cold", "gl-draw-point-stroke-active.cold", "gl-draw-point-active.cold", "gl-draw-point-static.cold", "gl-draw-point-point-stroke-inactive.hot", "gl-draw-point-inactive.hot", "gl-draw-point-stroke-active.hot", "gl-draw-point-active.hot", "gl-draw-point-static.hot"]

        mapboxgl.accessToken = 'pk.eyJ1Ijoib3VyZmFybXMiLCJhIjoiY2x3YWRhbW9nMGRsNjJxcHFwdW81emVhNSJ9.forvlRpP1nOZekrRDqBKjQ';
        const map = new mapboxgl.Map({
            container: 'map',
            // You can add layers to the predetermined slots within the Standard style basemap.
            // style: 'mapbox://styles/mapbox/standard',
            style: 'mapbox://styles/mapbox/satellite-v9',
            center: { lng: 174.95943864902665, lat: -37.70716520232802 }, //
            zoom: 9,
            projection: "mercator"
        });
        // Add the control to the map.
        map.addControl(new mapboxgl.NavigationControl());

        // Add the control to the map.
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            // Limit seach results to Australia.
            countries: 'nz',
            //placeholder 
            placeholder: 'Search address',
        })
        document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

        // Draw options
        var drawOptions = {
            displayControlsDefault: false,
            controls: {
                polygon: true,
                point: false,
                trash: true
            },
            userProperties: true,
        };
        var Draw = new MapboxDraw(drawOptions);
        const drawControll = map.addControl(Draw, 'top-right');

        // map.on('draw.modechange', function (event) {
        //     infoDiv.innerText = `Draw mode: ${event.mode}`
        // });

        const drawControllVisible = (visible) => {
            const display = visible ? "block" : "none"
            document.getElementsByClassName('mapboxgl-ctrl-group')[1].style.display = display
        }

        drawControllVisible(false)

        let popup;

        map.on('draw.selectionchange', function (event) {

            updatePolygonInfoTab()

            popup && popup.remove()
            if (currentMode === "simple_select") {
                //DISABLE DRAW When not in draw mode
                Draw.changeMode('simple_select')
                return;
            }

            infoDiv.innerHTML = ""
            const selectedPolygon = Draw.getSelected().features[0]

            if (!selectedPolygon) return;

            if (selectedPolygon) {
                const center = turf.centerOfMass(selectedPolygon).geometry.coordinates
                popup = new mapboxgl.Popup({
                    offset: [0, -15],
                })
                    .setLngLat(center)
                    .addTo(map);

                console.log('Creating element');
                const dropDown = document.createElement("select")
                dropDown.innerHTML = `
                    <option selected disabled value="">Select option</option>`
                    + soilClasses.map(item => {
                        return `<option value="${item.id}">${item.name}</option>`
                    }).join("")
                dropDown.addEventListener("change", (e) => {
                    const id = e.target.value
                    const data = soilClasses.find(item => item.id === parseInt(id))
                    if (data) {
                        const { color, name } = data
                        const polyId = Draw.getSelectedIds()[0]
                        if (!polyId) return
                        Draw.setFeatureProperty(polyId, 'color', color)
                        Draw.setFeatureProperty(polyId, 'name', name)
                        // console.log('123', 123);
                        popup.remove()
                        Draw.changeMode('simple_select')
                        Draw.changeMode('direct_select', { featureId: polyId });
                    }
                })

                infoDiv.appendChild(dropDown)

                const areaText = document.createElement("div")
                areaText.innerText = polyArea(selectedPolygon)
                infoDiv.appendChild(areaText)


                const selectCustomColor = document.createElement("div")
                selectCustomColor.style = "cursor:pointer; border:1px solid gray; padding:5px; margin-top:5px; border-radius:5px; text-align:center;"
                selectCustomColor.textContent = "Add option"

                selectCustomColor.addEventListener("click", () => {
                    showModal("Set custom option", () => {
                        //rebuild/update the drop down container with new custom value
                        dropDown.innerHTML = `
                            <option selected disabled value="">Select option</option>`
                            + soilClasses.map(item => {
                                return `<option value="${item.id}">${item.name}</option>`
                            }).join("")
                    })
                })

                infoDiv.appendChild(selectCustomColor)

            }

        });

        function polyArea(polygon) {
            const areaInSquareMeters = turf.area(polygon)
            const areaInHectares = areaInSquareMeters / 10000;
            return `Area: ${areaInHectares.toFixed(2)} ha`
        }

        map.on('load', () => {

            //DRAW styles update
            const filterOption = ['get', 'user_color']
            map.setPaintProperty("gl-draw-polygon-fill-inactive.cold", 'fill-color', filterOption)
            map.setPaintProperty("gl-draw-polygon-fill-active.cold", 'fill-color', filterOption)
            map.setPaintProperty("gl-draw-polygon-fill-static.cold", 'fill-color', filterOption)
            map.setPaintProperty("gl-draw-polygon-fill-inactive.hot", 'fill-color', filterOption)
            map.setPaintProperty("gl-draw-polygon-fill-active.hot", 'fill-color', filterOption)
            map.setPaintProperty("gl-draw-polygon-fill-static.hot", 'fill-color', filterOption)

            map.setPaintProperty("gl-draw-polygon-fill-inactive.cold", 'fill-opacity', 0.6)
            map.setPaintProperty("gl-draw-polygon-fill-active.cold", 'fill-opacity', 0.6)
            map.setPaintProperty("gl-draw-polygon-fill-static.cold", 'fill-opacity', 0.6)
            map.setPaintProperty("gl-draw-polygon-fill-inactive.hot", 'fill-opacity', 0.6)
            map.setPaintProperty("gl-draw-polygon-fill-active.hot", 'fill-opacity', 0.6)
            map.setPaintProperty("gl-draw-polygon-fill-static.hot", 'fill-opacity', 0.6)


            // map.addSource('wms-test-source', {
            //     type: 'raster',
            //     tiles: [
            //         'https://tiles-cdn.koordinates.com/services;key=1fe89c918dad495ca373b35a1d9e12a4/tiles/v4/layer=50804.404152,color=003399/{z}/{x}/{y}.png'
            //     ],
            //     tileSize: 256
            // });
            // map.addLayer({
            //     id: 'wms-test-layer',
            //     type: 'raster',
            //     'visibility': "visible",
            //     source: 'wms-test-source',
            //     paint: {}
            // });

            map.addSource('base', {
                type: 'vector',
                url: 'mapbox://ourfarms.b895136s'
            });
            map.addLayer(
                {
                    'id': 'base-data',
                    'type': 'fill',
                    'source': 'base',
                    'visibility': "visible",
                    'source-layer': 'nzpropertytitles',
                    'layout': {},
                    'paint': {
                        'fill-color': 'gray',
                        'fill-opacity': 0.5,
                    }
                },
            );
            map.addLayer(
                {
                    'id': 'base-data-outline',
                    'type': 'line',
                    'source': 'base',
                    'visibility': "visible",
                    'source-layer': 'nzpropertytitles',
                    'layout': {},
                    'paint': {
                        'line-color': 'black',
                        'line-width': 1
                    }
                },
            );

            map.addSource('waterways', {
                type: 'vector',
                url: 'mapbox://ourfarms.c10kf05t'
            });
            map.addLayer(
                {
                    'id': 'waterways-data',
                    'type': 'line',
                    'source': 'waterways',
                    'source-layer': 'river-flows-2nhit5',
                    'layout': {
                        'visibility': "none",
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': 'blue',
                        'line-width': 2
                    }
                },
            );

            // map.addSource('soil', {
            //     type: 'vector',
            //     url: 'mapbox://ourfarms.bkfvmvux'
            // });
            // map.addLayer(
            //     {
            //         'id': 'soil-data',
            //         'type': 'fill',
            //         'source': 'soil',
            //         'layout': {
            //             'visibility': "none",
            //         },
            //         'source-layer': 'mfe-fundamental-soil-layers-n-9901jl',
            //         'paint': {
            //             'fill-color': 'blue',
            //             'fill-opacity': 0.5
            //         }
            //     },
            // );

            map.addSource('landuse', {
                type: 'vector',
                url: 'mapbox://ourfarms.1tk8wn40'
            });
            map.addLayer(
                {
                    'id': 'landuse-data',
                    'type': 'line',
                    'source': 'landuse',
                    'source-layer': 'nzlri-land-use-capability-202-0csqzx',
                    'layout': {
                        'visibility': "none",
                    },
                    'paint': {
                        'line-color': 'white',
                        'line-width': 1
                    }
                },
            );
            map.addLayer(
                {
                    'id': 'landuse-data-fill',
                    'type': 'fill',
                    'source': 'landuse',
                    'source-layer': 'nzlri-land-use-capability-202-0csqzx',
                    'layout': {
                        'visibility': "none",
                    },
                    'paint': {
                        'fill-color': 'yellow',
                        'fill-opacity': 0
                    }
                },
            );

            map.addSource('lowslope', {
                type: 'vector',
                url: 'mapbox://ourfarms.3jcqeu12'
            });
            map.addLayer(
                {
                    'id': 'lowslope-data',
                    'type': 'fill',
                    'source': 'lowslope',
                    'source-layer': 'REDUCED-stock-exclusion-low-s-dos2ed',
                    'layout': {
                        'visibility': "none",
                    },
                    'paint': {
                        'fill-color': 'red',
                        'fill-opacity': 0.5
                    }
                },
            );

            map.addSource('farm-features', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': [
                        {
                            'type': 'Feature',
                            'properties': {
                                'name': 'Agrichemical Storage',
                            },
                            'geometry': {
                                'type': 'Point',
                                'coordinates': [174.95943864902665, -37.70716520232802]
                            }
                        },
                    ]
                }
            });
            // map.addLayer(
            //     {
            //         'id': 'farm-features',
            //         'type': 'circle',
            //         'source': 'farm-features',
            //         'layout': {
            //             'visibility': "none",
            //         },
            //         'paint': {
            //             'circle-radius': 6,
            //             'circle-color': 'red',
            //             'circle-stroke-color': 'white',
            //             'circle-stroke-width': 2
            //         },
            //         'filter': ['==', '$type', 'Point']
            //     },
            // );
            // map.addLayer(
            //     {
            //         'id': 'farm-features-text',
            //         'type': 'symbol',
            //         'source': 'farm-features',
            //         'layout': {
            //             'visibility': "none",
            //             'text-field': `{user_name}`,
            //             'text-font': [
            //                 'Open Sans Bold',
            //                 'Arial Unicode MS Bold'
            //             ],
            //             'text-size': 13,
            //             'text-letter-spacing': 0.05,
            //             'text-variable-anchor': ['left'],
            //             'text-radial-offset': 0.5,
            //             'text-max-width': 1000,
            //             'text-allow-overlap': true,
            //         },
            //         'paint': {
            //             'text-color': 'white',
            //             'text-halo-color': 'black',
            //             'text-halo-width': 1
            //         },
            //     },
            // );



            map.addLayer(
                {
                    'id': 'draw-farm-features-text',
                    'type': 'symbol',
                    'source': 'mapbox-gl-draw-cold',
                    'layout': {
                        'visibility': "none",
                        'text-field': `{user_name}`,
                        'text-font': [
                            'Open Sans Bold',
                            'Arial Unicode MS Bold'
                        ],
                        'text-size': 13,
                        'text-letter-spacing': 0.05,
                        'text-variable-anchor': ['left'],
                        'text-radial-offset': 0.5,
                        'text-max-width': 1000,
                        'text-allow-overlap': true,
                    },
                    'paint': {
                        'text-color': 'white',
                        'text-halo-color': 'black',
                        'text-halo-width': 1
                    },
                    filter: ['==', '$type', 'Point']
                },
            );
            map.addLayer(
                {
                    'id': 'draw-farm-features-text-hot',
                    'type': 'symbol',
                    'source': 'mapbox-gl-draw-hot',
                    'layout': {
                        'visibility': "none",
                        'text-field': `{user_name}`,
                        'text-font': [
                            'Open Sans Bold',
                            'Arial Unicode MS Bold'
                        ],
                        'text-size': 13,
                        'text-letter-spacing': 0.05,
                        'text-variable-anchor': ['left'],
                        'text-radial-offset': 0.5,
                        'text-max-width': 1000,
                        'text-allow-overlap': true,
                    },
                    'paint': {
                        'text-color': 'white',
                        'text-halo-color': 'black',
                        'text-halo-width': 1
                    },
                    filter: ['==', '$type', 'Point']
                },
            );


            map.on("click", "farm-features", e => {
                const features = map.queryRenderedFeatures(e.point, { layers: ['farm-features'] });
                if (!features.length) {
                    return;
                }

                console.log('click', features);
                //move with Draw 


                Draw.add(features[0])
            })


            map.on('click', 'landuse-data-fill', (e) => {

                const drawMode = Draw.getMode()
                console.log('drawMode', drawMode);

                if (landUseClickLock) { return }

                if (drawMode === "draw_polygon" || drawMode === "direct_select") {
                    return
                }

                console.log('currentMode', currentMode);
                // if (Draw.getMode() !== "simple_select") return;
                if (currentMode !== "simple_select") return;

                const features = map.queryRenderedFeatures(e.point, { layers: ['landuse-data-fill'] });
                if (!features.length) {
                    return;
                }

                const feature = features[0];
                const polygonId = feature.properties.polyid
                const info = feature.properties.nzcu_descr

                updateLandUseColorsLayer(polygonId)

                // const soilClasses = [
                //     { id: 1, name: "steep country", color: "red" },
                //     { id: 2, name: "medium to steep country", color: "orange" },
                //     { id: 3, name: "cultivable rolling country", color: "purple" },
                //     { id: 4, name: "River flats", color: "blue" },
                // ]

                // const dropDown = document.createElement("select")
                // dropDown.innerHTML = `<option  selected disabled  value="">Select option</option>`
                //     + soilClasses.map(item => {
                //         return `<option value="${item.color}">${item.name}</option>`
                //     }).join("")
                // dropDown.addEventListener("change", (e) => {
                //     const selectedValue = e.target.value
                //     const polygon = landUseColors.find(item => item.id === polygonId)
                //     if (polygon) {
                //         polygon.color = selectedValue
                //     } else {
                //         landUseColors.push({
                //             id: polygonId,
                //             color: selectedValue,
                //         })
                //     }
                //     updateLandUseColorsLayer()
                // })

                const contentDiv = document.createElement("div")
                contentDiv.appendChild(document.createTextNode(info))
                // contentDiv.appendChild(dropDown)

                const popup = new mapboxgl.Popup({
                    offset: [0, -15],
                })
                    .setLngLat(e.lngLat)
                    .setDOMContent(contentDiv)
                    .addTo(map);

                popup.once('close', function () {
                    updateLandUseColorsLayer()
                });
            });

            map.on("click", "base-data", e => {

                if (lockPropertyFromClick) return;

                const features = map.queryRenderedFeatures(e.point, { layers: ['base-data'] });
                if (!features.length) {
                    return;
                }

                const feature = features[0];
                console.log('feature', feature);
                const polygonId = feature.properties.id

                if (selectedBasePolygons.includes(polygonId)) {
                    selectedBasePolygons.splice(selectedBasePolygons.indexOf(polygonId), 1)
                } else {
                    selectedBasePolygons.push(polygonId)
                }

                map.setPaintProperty('base-data', 'fill-opacity', [
                    'case',
                    ['in', ['get', 'id'], ['literal', selectedBasePolygons]],
                    0,
                    0.5
                ]);

                // propertyListDiv.innerHTML = selectedBasePolygons.map(p => {
                //     return `${p}`
                // }).join("</br>")
            })
            loadPropertyControls()
            buildLoadPolygonsButton()


            drawPontLayers.forEach(layer => {
                map.setLayoutProperty(layer, 'visibility', 'none')
            })
        });


        const divLock = document.createElement("div")
        //divLock.style = "display:flex; border:1px solid red;"
        const property = buildSwitcher("Property", checked => {
            const display = checked ? "visible" : "none"
            map.setLayoutProperty('base-data', 'visibility', display);
        }, false, true)

        const lockProperty = buildSwitcher("Lock", checked => {
            lockPropertyFromClick = checked
        }, false, true)

        divLock.appendChild(property.div)
        //divLock.appendChild(lockProperty.div)
        switchersEnableDiv.appendChild(divLock)


        const landUse = buildSwitcher("Land Use Capability", checked => {
            const display = checked ? "visible" : "none"
            map.setLayoutProperty('landuse-data', 'visibility', display);
            map.setLayoutProperty('landuse-data-fill', 'visibility', display);
        }, false, false)

        const landUseLock = buildSwitcher("Lock", checked => {
            landUseClickLock = checked
        }, false, true)

        switchersEnableDiv.appendChild(landUse.div)

        const waterways = buildSwitcher("Waterways", checked => {
            const display = checked ? "visible" : "none"
            map.setLayoutProperty('waterways-data', 'visibility', display);
        }, false, false)
        switchersEnableDiv.appendChild(waterways.div)


        const farmFeatures = buildSwitcher("Farm Features", checked => {
            const display = checked ? "visible" : "none"
            drawPontLayers.forEach(layer => {
                map.setLayoutProperty(layer, 'visibility', display)
            })
            map.setLayoutProperty('draw-farm-features-text', 'visibility', display);
            map.setLayoutProperty('draw-farm-features-text-hot', 'visibility', display);
        }, false, false)
        switchersEnableDiv.appendChild(farmFeatures.div)

        // const soil = buildSwitcher("Soil", checked => {
        //     const display = checked ? "visible" : "none"
        //     map.setLayoutProperty('soil-data', 'visibility', display);
        // }, false, false)
        // switchersEnableDiv.appendChild(soil.div)


        actionsListDiv.appendChild(buildActionButton({
            name: "Select your property", callback: () => {
                Draw.changeMode(Draw.modes.SIMPLE_SELECT)
                lockProperty.turnOff()
                property.turnOn()
                //landUse.turnOff()
                currentMode = "simple_select"
                drawControllVisible(false)
                landUseClickLock = true

                changeCursor("pointer")

                saveAndLoadDiv.style.display = "flex"
                editMode(true)
            }
        }))
        actionsListDiv.appendChild(buildActionButton({
            name: "Map your Land Units", callback: () => {
                lockProperty.turnOn()
                property.turnOn()
                //landUse.turnOn()
                //disable interactivity for landUse layer
                drawControllVisible(true)

                changeCursor("")
                Draw.changeMode('draw_polygon')
                currentMode = "draw_polygon"

                saveAndLoadDiv.style.display = "flex"

                editMode(true)
            }
        }))
        actionsListDiv.appendChild(buildActionButton({
            name: "View LU/Soils info", callback: () => {
                // property.turnOff()
                landUse.turnOn()
                lockProperty.turnOn()
                currentMode = "simple_select"
                Draw.changeMode('simple_select')
                drawControllVisible(false)
                landUseClickLock = false

                changeCursor("pointer")

                closeControl.style.display = "flex"
                editMode(true)
            }
        }))

        actionsListDiv.appendChild(buildActionButton({
            name: "Map Farm Features", callback: () => {
                //Draw.changeMode(Draw.modes.DRAW_POINT)
                farmFeatures.turnOn()
                farmFeaturesListDiv.style.display = "flex"
                saveAndLoadDiv.style.display = "flex"

                lockProperty.turnOn()
                landUseClickLock = true
                editMode(true)
            }
        }))

        function editMode(enabled) {

            if (enabled) {
                editPanel.style.filter = "blur(5px)"
                editPanel.style.pointerEvents = "none"
            } else {
                editPanel.style.filter = "none"
                editPanel.style.pointerEvents = "auto"
            }

        }

        function changeCursor(cursorType) {
            map.getCanvas().style.cursor = cursorType;
        }

        function buildLoadPolygonsButton() {

            const loadButton = document.createElement("button")
            loadButton.innerText = "Load"
            loadButton.addEventListener("click", () => {
                const appPolygonsData = localStorage.getItem('appPolygonsData')
                if (appPolygonsData) {
                    const polygonsArray = JSON.parse(appPolygonsData)
                    console.log('polygonsArray', polygonsArray);
                    Draw.add(polygonsArray)
                    updatePolygonInfoTab()
                }
            })

            loadPolygons.appendChild(loadButton)
        }

        function updatePolygonInfoTab() {

            propertyListDiv.innerHTML = ""

            const polygons = Draw.getAll().features
            polygons.forEach(poly => {

                const area = turf.area(poly)
                if (area <= 0) return;//skip empty polygons

                const div = document.createElement("div")
                div.style.display = "flex"
                div.style.alignItems = "center"
                div.style.gap = "15px"
                div.style.justifyContent = "space-between"


                const color = document.createElement("div")
                color.style.backgroundColor = poly.properties.color
                color.style.width = "20px"
                color.style.height = "20px"
                color.style.borderRadius = "20px"

                const text = document.createElement("span")
                text.innerText = poly.properties.name

                const areaDiv = document.createElement("span")
                areaDiv.innerText = polyArea(poly)

                const deleteButton = document.createElement("div")
                deleteButton.style.cursor = "pointer"
                const deleteIcon = document.createElement("img")
                deleteIcon.src = "icons/rubbish-bin-svgrepo-com.svg"
                deleteIcon.style.width = "20px"
                deleteIcon.style.height = "20px"
                deleteButton.addEventListener("click", () => {
                    Draw.delete(poly.id)
                    updatePolygonInfoTab()

                    saveAndLoadDiv.style.display = "flex"
                })
                deleteButton.appendChild(deleteIcon)


                const editButton = document.createElement("div")
                editButton.style.cursor = "pointer"
                const editIcon = document.createElement("img")
                editIcon.src = "icons/edit-3-svgrepo-com.svg"
                editIcon.style.width = "20px"
                editIcon.style.height = "20px"
                editIcon.addEventListener("click", () => {
                    Draw.changeMode('direct_select', { featureId: poly.id });
                    currentMode = "direct_select"
                    drawControllVisible(true)
                    landUseClickLock = true

                    saveAndLoadDiv.style.display = "flex"

                    editMode(true)
                })
                editButton.appendChild(editIcon)

                const left = document.createElement("div")
                left.className = "flex-nowrap"
                left.appendChild(color)
                left.appendChild(text)
                left.appendChild(areaDiv)

                const right = document.createElement("div")
                right.className = "flex-nowrap"
                right.appendChild(editButton)
                right.appendChild(deleteButton)

                div.appendChild(left)
                div.appendChild(right)

                propertyListDiv.appendChild(div)
            })


        }


        function updateLandUseColorsLayer(selectedId) {

            map.setPaintProperty('landuse-data-fill', 'fill-opacity', 0);

            const colors = landUseColors.map(item => {
                return [item.id, item.color]
            })

            const opacity = landUseColors.map(item => {
                return [item.id, 0.5]
            })

            //hightligh selected polygon
            if (selectedId && !landUseColors.find(item => item.id === selectedId)) {
                opacity.push([selectedId, 0.5])
            }

            if (colors.length > 0) {
                map.setPaintProperty('landuse-data-fill', 'fill-color', [
                    'match',
                    ['get', 'polyid'],
                    ...colors.flat(),
                    'yellow'
                ]);
            }

            if (opacity.length > 0) {
                map.setPaintProperty('landuse-data-fill', 'fill-opacity', [
                    'match',
                    ['get', 'polyid'],
                    ...opacity.flat(),
                    0
                ]);
            }

        }

        function loadPropertyControls() {

            const saveButton = document.createElement("button")
            saveButton.innerText = "Save & Close"
            saveButton.addEventListener("click", () => {

                if (selectedBasePolygons) {
                    localStorage.setItem('appPolygonsData', JSON.stringify(
                        Draw.getAll()
                    ))
                }

                Draw.changeMode(Draw.modes.SIMPLE_SELECT)
                currentMode = "simple_select"
                lockProperty.turnOn()
                drawControllVisible(false)
                landUseClickLock = true

                farmFeaturesListDiv.style.display = "none"

                saveAndLoadDiv.style.display = "none"

                editMode(false)
            })

            // const loadButton = document.createElement("button")
            // loadButton.innerText = "Load"
            // loadButton.addEventListener("click", () => {
            //     const appPolygonsData = localStorage.getItem('appPolygonsData')
            //     if (appPolygonsData) {
            //         const polygonsArray = JSON.parse(appPolygonsData)
            //         console.log('polygonsArray', polygonsArray);
            //         Draw.add(polygonsArray)
            //         updatePolygonInfoTab()
            //     }
            // })
            propertyControlsDiv.appendChild(saveButton)
            // propertyControlsDiv.appendChild(loadButton)


            const closeButton = document.createElement("button")
            closeButton.innerText = "Close"
            closeButton.addEventListener("click", () => {

                Draw.changeMode(Draw.modes.SIMPLE_SELECT)
                currentMode = "simple_select"
                lockProperty.turnOn()
                drawControllVisible(false)
                landUseClickLock = true

                farmFeaturesListDiv.style.display = "none"
                saveAndLoadDiv.style.display = "none"
                closeControl.style.display = "none"

                editMode(false)
            })
            closeControl.appendChild(closeButton)
        }

        function buildActionButton({ name, callback }) {
            const div = document.createElement("div")
            div.className = "action-button"
            div.style.display = "flex"
            div.style.alignItems = "center"
            div.style.cursor = "pointer"
            div.style.gap = "5px"
            div.style.userSelect = "none"

            div.addEventListener("click", () => {
                if (typeof callback === "function") callback()
            })

            const image = document.createElement("img")
            image.src = "icons/edit.svg"
            image.style.width = "20px"
            image.style.height = "20px"
            div.appendChild(image)

            const text = document.createElement("span")
            text.innerText = name
            div.appendChild(text)

            return div
        }



        function buildSwitcher(labelText, action, colorCircle, checked = true) {

            const div = document.createElement("div")
            div.className = "switcher-div"
            div.style.cursor = "pointer"

            const label = document.createElement("label")
            label.className = "switch"

            const checkbox = document.createElement("input")
            checkbox.type = "checkbox"
            checkbox.checked = checked

            // checkbox.addEventListener("input", () => {
            //     if (typeof action === "function") {
            //         action(checkbox.checked)
            //     }
            // })

            div.addEventListener("click", () => {
                checkbox.checked = !checkbox.checked
                if (typeof action === "function") {
                    action(checkbox.checked)
                }
            })

            function turnOn() {
                checkbox.checked = true
                if (typeof action === "function") {
                    action(checkbox.checked)
                }
            }

            function turnOff() {
                checkbox.checked = false
                if (typeof action === "function") {
                    action(checkbox.checked)
                }
            }

            const color = document.createElement("div")
            color.style.width = "10px"
            color.style.height = "10px"
            color.style.backgroundColor = colorCircle
            color.style.borderRadius = "10px"
            color.style.border = "1px solid #2196f3"

            const span = document.createElement("span")
            span.className = "slider round"

            const text = document.createElement("div")
            text.innerText = labelText

            label.appendChild(checkbox)
            label.appendChild(span)

            div.appendChild(label)
            if (colorCircle) div.appendChild(color)
            div.appendChild(text)

            return { div, turnOn, turnOff }
        }

        createFarmFeaturesList()
        function createFarmFeaturesList() {
            farmFeaturesNames.forEach(item => {
                const div = document.createElement("div")
                div.style.display = "flex"
                div.style.alignItems = "center"
                div.style.border = "1px solid #ccc"
                div.style.borderRadius = "5px"
                div.style.padding = "5px"
                div.style.cursor = "pointer"
                div.style.userSelect = "none"
                const text = document.createElement("span")
                text.innerText = ' + ' + item
                div.appendChild(text)

                div.addEventListener("click", () => {

                    Draw.changeMode(Draw.modes.DRAW_POINT)

                    map.once('draw.create', function (e) {
                        //draw get last id 
                        const id = e.features[0].id
                        console.log('id', id);
                        Draw.setFeatureProperty(id, "name", item)
                    })

                    //cursor 
                    // changeCursor("crosshair")
                    // map.once('click',
                    //     function (e) {
                    //         const coordinates = e.lngLat
                    //         const feature = {
                    //             'type': 'Feature',
                    //             'properties': {
                    //                 'user_name': item,
                    //             },
                    //             'geometry': {
                    //                 'type': 'Point',
                    //                 'coordinates': [coordinates.lng, coordinates.lat]
                    //             }
                    //         }
                    //         map.getSource('farm-features').setData({
                    //             'type': 'FeatureCollection',
                    //             'features': [
                    //                 ...map.getSource('farm-features')._data.features,
                    //                 feature
                    //             ]
                    //         })
                    //         changeCursor("pointer")
                    //     }
                    // )

                    // map.once('draw.create', function (e) {
                    //     //draw get last id 
                    //     const id = e.features[0].id
                    //     console.log('id', id);
                    //     Draw.setFeatureProperty(id, "name", item)
                    // })

                    // map.once('draw.create', function (e) {
                    //     const coordinates = e.features[0].geometry.coordinates
                    //     const feature = {
                    //         'type': 'Feature',
                    //         'properties': {
                    //             'name': item,
                    //         },
                    //         'geometry': {
                    //             'type': 'Point',
                    //             'coordinates': coordinates
                    //         }
                    //     }
                    //     map.getSource('farm-features').setData({
                    //         'type': 'FeatureCollection',
                    //         'features': [
                    //             ...map.getSource('farm-features')._data.features,
                    //             feature
                    //         ]
                    //     })
                    //     Draw.changeMode('simple_select')
                    //     //Draw delete last point
                    //     Draw.delete(e.features[0].id)

                    //     currentMode = "simple_select"
                    // });

                })
                farmFeaturesListDiv.appendChild(div)
            })
        }

        function createObservableArray(callback) {
            // Handler for the Proxy
            const handler = {
                // Intercepting the 'set' operation
                set(target, property, value, receiver) {
                    let result = Reflect.set(target, property, value, receiver);
                    // Trigger the callback
                    if (property === 'length' || !isNaN(property)) {
                        callback(target);
                    }
                    return result;
                },
                // Intercepting the 'deleteProperty' operation
                deleteProperty(target, property) {
                    let result = Reflect.deleteProperty(target, property);
                    // Trigger the callback
                    callback(target);
                    return result;
                },
            };
            // Creating a Proxy around an empty array
            return new Proxy([], handler);
        }

        function callback(target, property, value) {
            console.log(`Array updated: target = ${target}, property = ${property}, value = ${value}`);
            // propertyListDiv.innerHTML = target.map(p => {
            //     return `${p}`
            // }).join("</br>");
        };



        function showModal(title, okCallback, cancelCallback) {
            const modalContainer = document.getElementById('modal-container');

            const modal = document.createElement('div');
            modal.className = 'modal';

            const modalHeader = document.createElement('div');
            modalHeader.className = 'modal-header';

            const modalTitle = document.createElement('h2');
            modalTitle.className = 'modal-title';
            modalTitle.innerText = title;

            const container = document.createElement('div');
            container.style = `display: flex;
                            flex-direction: row-reverse;
                            justify-content: space-between;
                            `;
            const inputName = document.createElement('input');
            inputName.style.padding = '5px';
            inputName.type = 'text';
            inputName.id = 'customName';
            inputName.placeholder = 'Set name';


            const svgIcon = document.createElement('img');
            svgIcon.src = 'icons/color_circle.png';
            svgIcon.alt = 'Color Picker Icon';
            svgIcon.style.width = '40px';
            svgIcon.style.height = '40px';
            svgIcon.style.cursor = 'pointer';
            container.appendChild(svgIcon);
            const inputColor = document.createElement('input');
            inputColor.type = 'color';
            inputColor.id = 'customColor';
            inputColor.style.width = '0';
            inputColor.style.height = '0';
            inputColor.style.opacity = '0';

            container.appendChild(inputColor);
            svgIcon.addEventListener('click', function () {
                inputColor.click();
            });

            container.appendChild(inputName);

            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.appendChild(container);

            modalHeader.appendChild(modalTitle);
            modal.appendChild(modalHeader);
            modal.appendChild(modalContent);
            modalContainer.appendChild(modal);

            const modalButtons = document.createElement('div');
            modalButtons.className = 'modal-buttons';

            const okButton = document.createElement('button');
            okButton.className = 'modal-button';
            okButton.innerText = 'OK';
            okButton.onclick = () => {
                soilClasses.push({
                    id: soilClasses.length + 1,
                    name: inputName.value,
                    color: inputColor.value
                });

                if (typeof okCallback === 'function') {
                    okCallback();
                }
                modalContainer.style.display = 'none';
                modalContainer.innerHTML = ''; // Clear the modal content
            };

            const cancelButton = document.createElement('button');
            cancelButton.className = 'modal-button cancel';
            cancelButton.innerText = 'Cancel';
            cancelButton.onclick = () => {
                if (typeof cancelCallback === 'function') {
                    cancelCallback();
                }
                modalContainer.style.display = 'none';
                modalContainer.innerHTML = ''; // Clear the modal content
            };

            modalButtons.appendChild(okButton);
            modalButtons.appendChild(cancelButton);
            modal.appendChild(modalButtons);

            modalContainer.style.display = 'flex';
        }



    </script>

</body>

</html>